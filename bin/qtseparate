#!/usr/bin/env ruby

# gems
require 'pathname3'

# ours
$LOAD_PATH.unshift(File.join(File.realpath(File.dirname($0)), '..', 'lib'))
require 'quadtone'
include Quadtone

###

montage = nil

quad_file = ARGV.shift or begin
  warn "Must specify quad curves file"
  exit 1
end

quad_file = Pathname.new(quad_file)

quad = QuadCurves.from_file(quad_file)

if ARGV.first == '--info'
  ARGV.shift
  warn "#{quad_file}: inks = #{quad.inks}"
  exit 0
end

if ARGV.first == '--montage'
  ARGV.shift
  montage = true
end

if ARGV.first == '--gradient'
  image_file = Pathname.new('gradient.tif')
  image = Magick::Image.new(200, 200, Magick::GradientFill.new(0, 0, 0, 200, 'white', 'black'))
else
  image_file = Pathname.new(ARGV.shift)
  image = Magick::Image.read(image_file).first
end

quad_name = quad_file.basename.sub(/#{Regexp.quote(quad_file.extname)}/, '')
separated_image_file = image_file.basename.sub(/#{Regexp.quote(image_file.extname)}/, "--#{quad_name}.tif")

separator = Separator.new(quad)
separated_image = separator.separate(image)
separated_image = separated_image.montage if montage
;;warn "writing #{separated_image_file}"
separated_image.write(separated_image_file) { self.compression = Magick::ZipCompression }